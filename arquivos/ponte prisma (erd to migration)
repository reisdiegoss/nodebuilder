import * as fs from 'fs';
import * as path from 'path';

/**
 * PrismaBridgeService: Transforma o diagrama visual em schema.prisma real.
 * Esta é a ponte que torna o NodeBuilder funcional.
 */

export class PrismaBridgeService {
  
  /**
   * Gera o corpo do arquivo schema.prisma baseado no JSON do ERDModeler
   */
  public static generatePrismaFromJSON(tables: any[]): string {
    let prismaSchema = `
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
`;

    tables.forEach(table => {
      prismaSchema += `\nmodel ${table.name} {`;
      
      table.columns.forEach((col: any) => {
        let fieldDef = `  ${col.name} ${this.mapType(col.type)}`;
        
        if (col.isPk) fieldDef += " @id @default(autoincrement())";
        if (col.isUnique) fieldDef += " @unique";
        if (!col.required) fieldDef += "?";

        prismaSchema += `\n${fieldDef}`;
      });

      // Injeção automática da coluna Tenant para Multi-tenant
      prismaSchema += `\n  tenant_id Int @default(1)`;
      
      prismaSchema += `\n}\n`;
    });

    return prismaSchema;
  }

  private static mapType(uiType: string): string {
    const types: Record<string, string> = {
      'INTEGER': 'Int',
      'VARCHAR': 'String',
      'TEXT': 'String',
      'BOOLEAN': 'Boolean',
      'DATE': 'DateTime',
      'FLOAT': 'Float'
    };
    return types[uiType] || 'String';
  }
}