/**
 * Parser de Código do NodeBuilder.
 * Atualizado para ser "Tenant-Aware" e lidar com Widgets Complexos.
 */

export class NBParser {
  
  public static parseModule(metadata: any, projectConfig: any): string {
    const { type, name, components } = metadata;
    const isSingleDb = projectConfig.multiTenantType === 'SINGLE_DB';

    let code = `
import { NPage, NForm, NInput, NDataGrid, NUniqueSearch } from '@nodebuilder/core';
import { z } from 'zod';

export default class ${name} extends NPage {
  private form: NForm;

  constructor() {
    super();
    this.form = new NForm('${name}_form');
    
    ${this.generateComponentsCode(components)}

    // Injeção de Segurança Multi-tenant Nativa
    ${isSingleDb ? `this.applyTenantFilter(session.tenantId);` : ''}
  }

  public async onSave(data: any) {
     // Lógica automática de salvamento injetada pelo Parser
  }
}
`;
    return code;
  }

  private static generateComponentsCode(components: any[]): string {
    return components.map(comp => {
      if (comp.type === 'FK') {
        return `const ${comp.name} = new NUniqueSearch('${comp.label}', '${comp.targetTable}', '${comp.endpoint}', '${comp.displayField}');`;
      }
      return `const ${comp.name} = new NInput('${comp.name}', '${comp.label}');`;
    }).join('\n    ');
  }
}