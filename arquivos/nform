import { z } from 'zod';

/**
 * NForm: O cérebro do formulário NodeBuilder.
 * Agora inclui validação nativa via Zod e persistência.
 */

export class NForm {
  private name: string;
  private data: Record<string, any> = {};
  private schema: z.ZodObject<any> | null = null;
  private errors: Record<string, string> = {};
  private targetModel: string = '';

  constructor(name: string) {
    this.name = name;
  }

  /**
   * Vincula o formulário a um modelo do Prisma no servidor gerado
   */
  public linkTo(modelName: string) {
    this.targetModel = modelName;
    return this;
  }

  /**
   * Define o esquema de validação
   */
  public setValidationSchema(schema: any) {
    this.schema = schema;
    return this;
  }

  public setData(data: any) {
    this.data = { ...data };
  }

  public getData() {
    return this.data;
  }

  /**
   * Valida os dados e retorna boolean.
   * Mensagens de erro são armazenadas para exibição nos widgets.
   */
  public async validate(): Promise<boolean> {
    if (!this.schema) return true;

    try {
      this.schema.parse(this.data);
      this.errors = {};
      return true;
    } catch (err: any) {
      if (err instanceof z.ZodError) {
        const formattedErrors: any = {};
        err.errors.forEach((e) => {
          formattedErrors[e.path[0]] = e.message;
        });
        this.errors = formattedErrors;
      }
      return false;
    }
  }

  public getError(field: string): string | undefined {
    return this.errors[field];
  }
}