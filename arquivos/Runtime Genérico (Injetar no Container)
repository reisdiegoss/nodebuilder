import { PrismaClient } from '@prisma/client';

/**
 * RuntimeCRUDService
 * Este arquivo é injetado dentro do container do cliente.
 * Ele serve como o "Backend Genérico" para alimentar o NDataGrid e NUniqueSearch.
 */
export class RuntimeCRUDService {
  private prisma: PrismaClient;

  constructor(prismaClient: PrismaClient) {
    this.prisma = prismaClient;
  }

  /**
   * Processa requisições do NDataGrid (Paginação, Busca, Sort)
   */
  async handleList(model: string, query: any, tenantId: number) {
    const page = Number(query.page) || 1;
    const limit = Number(query.limit) || 10;
    const search = query.search || '';
    const sortField = query.sort || 'id';
    const sortDir = query.dir || 'desc';

    // 1. Definição de Filtros (Busca Global + Tenant)
    const where: any = {
      tenant_id: tenantId, // Segurança Multi-tenant forçada
    };

    if (search) {
      // Tenta buscar em campos string comuns
      where['OR'] = [
        { nome: { contains: search, mode: 'insensitive' } },
        { descricao: { contains: search, mode: 'insensitive' } },
        { email: { contains: search, mode: 'insensitive' } },
      ];
    }

    // 2. Consulta ao Banco
    // @ts-ignore - O model é dinâmico
    const delegate = this.prisma[model];
    
    if (!delegate) throw new Error(`Model ${model} não encontrado no Prisma.`);

    const [total, data] = await Promise.all([
      delegate.count({ where }),
      delegate.findMany({
        where,
        take: limit,
        skip: (page - 1) * limit,
        orderBy: { [sortField]: sortDir }
      })
    ]);

    // 3. Retorno no formato padrão do NDataGrid
    return {
      data,
      meta: {
        total,
        page,
        last_page: Math.ceil(total / limit)
      }
    };
  }

  /**
   * Processa buscas do NUniqueSearch (Autocomplete)
   */
  async handleLookup(model: string, search: string, tenantId: number) {
     // @ts-ignore
    const delegate = this.prisma[model];
    if (!delegate) return [];

    return delegate.findMany({
      where: {
        tenant_id: tenantId,
        OR: [
          { nome: { contains: search, mode: 'insensitive' } }
        ]
      },
      take: 20,
      select: { id: true, nome: true } // Padrão ID/Nome
    });
  }
}