/**
 * ApiRouteGenerator
 * Responsável por criar o arquivo 'routes.ts' dentro do projeto gerado.
 * Ele expõe os endpoints que os widgets visuais vão consumir.
 */
export class ApiRouteGenerator {

    public static generateRoutes(modules: any[]): string {
        const imports = `
import { FastifyInstance } from 'fastify';
import { RuntimeCRUDService } from './services/RuntimeCRUDService';
import { prisma } from './lib/prisma';
`;

        let routes = `
export async function appRoutes(app: FastifyInstance) {
  const runtime = new RuntimeCRUDService(prisma);
`;

        // Para cada tabela/módulo desenhado, cria as rotas CRUD
        modules.forEach(mod => {
            const modelName = mod.name.toLowerCase(); // ex: 'clientes'

            routes += `
  // Rotas para o módulo: ${mod.name}
  
  // 1. Listagem para NDataGrid
  app.get('/api/${modelName}', async (req: any, reply) => {
    const tenantId = req.user.tenantId; // Via JWT/Middleware
    const result = await runtime.handleList('${mod.name}', req.query, tenantId);
    return result;
  });

  // 2. Lookup para NUniqueSearch
  app.get('/api/${modelName}/lookup', async (req: any, reply) => {
    const tenantId = req.user.tenantId;
    const result = await runtime.handleLookup('${mod.name}', req.query.search, tenantId);
    return result;
  });

  // 3. Salvar (Create/Update) para NForm
  app.post('/api/${modelName}', async (req: any, reply) => {
    const tenantId = req.user.tenantId;
    const data = { ...req.body, tenant_id: tenantId };
    
    // @ts-ignore
    const result = req.body.id 
      ? await prisma.${mod.name}.update({ where: { id: req.body.id }, data })
      : await prisma.${mod.name}.create({ data });
      
    return result;
  });
      
  app.delete('/api/${modelName}/:id', async (req: any, reply) => {
     // @ts-ignore
     await prisma.${mod.name}.delete({ where: { id: Number(req.params.id) } });
     return { success: true };
  });
`;
        });

        routes += `\n}`;
        return imports + routes;
    }
}