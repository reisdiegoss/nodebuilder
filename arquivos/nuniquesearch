import React, { useState } from 'react';
import { Search, X } from 'lucide-react';
import { NDataGrid } from './NDataGrid';

/**
 * NUniqueSearch: Permite buscar registros em tabelas relacionadas via Modal.
 * Fundamental para Low-code: Vínculo visual de Chave Estrangeira.
 */

interface NUniqueSearchProps {
    label: string;
    targetModel: string; // Ex: 'clientes'
    targetEndpoint: string; // Ex: '/api/v1/clientes'
    displayField: string; // O que mostrar após selecionar (ex: 'nome')
    onSelect: (id: string, label: string) => void;
    value?: string;
    placeholder?: string;
}

export const NUniqueSearch: React.FC<NUniqueSearchProps> = ({
    label,
    targetModel,
    targetEndpoint,
    displayField,
    onSelect,
    value,
    placeholder = "Clique para buscar..."
}) => {
    const [isModalOpen, setIsModalOpen] = useState(false);
    const [selectedLabel, setSelectedLabel] = useState('');

    const handleSelection = (id: string, item: any) => {
        const labelValue = item[displayField];
        setSelectedLabel(labelValue);
        onSelect(id, labelValue);
        setIsModalOpen(false);
    };

    return (
        <div className= "space-y-1.5 w-full" >
        <label className="text-xs font-bold text-slate-600 uppercase tracking-tight ml-1" > { label } </label>

            < div className = "relative group" >
                <input
          type="text"
    readOnly
    placeholder = { placeholder }
    value = { selectedLabel || value || ''
}
onClick = {() => setIsModalOpen(true)}
className = "w-full bg-white border border-slate-300 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer group-hover:border-blue-400 transition-all"
    />
    <Search className="absolute right-3 top-3 text-slate-400 group-hover:text-blue-500 transition-colors" size = { 20} />
        </div>

{/* MODAL DE BUSCA (Framer-motion facilitaria, mas usaremos Tailwind Puro para estabilidade) */ }
{
    isModalOpen && (
        <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[999] flex items-center justify-center p-6" >
            <div className="bg-white w-full max-w-4xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[85vh]" >
                <div className="p-4 bg-slate-50 border-b border-slate-200 flex items-center justify-between" >
                    <h3 className="font-bold text-slate-700" > Selecionar { targetModel } </h3>
                        < button onClick = {() => setIsModalOpen(false)
} className = "text-slate-400 hover:text-red-500 transition-colors" >
    <X size={ 24 } />
        </button>
        </div>

        < div className = "p-6 overflow-y-auto flex-1 bg-slate-50/30" >
            <NDataGrid
                endpoint={ targetEndpoint }
columns = {
    [
    { name: 'id', label: 'ID' },
    { name: displayField, label: 'Nome/Descrição', sortable: true }
    ]}
pageSize = { 5}
actions = {{
    onEdit: (id) => handleSelection(id, { [displayField]: 'Item selecionado' }) // Simplificado para o exemplo
}}
              />
    </div>
    </div>
    </div>
      )}
</div>
  );
};